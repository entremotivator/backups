{
  "active": false,
  "connections": {
    "baseInfo": {
      "main": [
        [
          {
            "node": "Switch Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found slots?": {
      "main": [
        [
          {
            "node": "Adjust DateTime 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Availability Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a booking": {
      "main": [
        [
          {
            "node": "found booking?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EWT": {
      "main": [
        [
          {
            "node": "baseInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Action": {
      "main": [
        [
          {
            "node": "Cal Availability",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "all events?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cal Availability 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Action 2": {
      "main": [
        [
          {
            "node": "booking cancelled?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cal Availability ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response A Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule a booking": {
      "main": [
        [
          {
            "node": "scheduled?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancel a booking": {
      "main": [
        [
          {
            "node": "Response Cancel Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reschedule a booking": {
      "main": [
        [
          {
            "node": "Response Reschedule Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "booking cancelled?": {
      "main": [
        [
          {
            "node": "Response Bokking Cancelled",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancel a booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adjust DateTime 1": {
      "main": [
        [
          {
            "node": "Format Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adjust DateTime 2": {
      "main": [
        [
          {
            "node": "Response All Bookings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Slots": {
      "main": [
        [
          {
            "node": "Response Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get all bookings by Event": {
      "main": [
        [
          {
            "node": "Adjust DateTime 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get all bookings": {
      "main": [
        [
          {
            "node": "Adjust DateTime 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "all events?": {
      "main": [
        [
          {
            "node": "Get all bookings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get all bookings by Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "scheduled?": {
      "main": [
        [
          {
            "node": "Response Schedule Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Schedule Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found booking?": {
      "main": [
        [
          {
            "node": "Switch Action 2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Get Booking Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cal Availability": {
      "main": [
        [
          {
            "node": "found slots?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found slot?": {
      "main": [
        [
          {
            "node": "Schedule a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Not Availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cal Availability 2": {
      "main": [
        [
          {
            "node": "found slot?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found slot?1": {
      "main": [
        [
          {
            "node": "Reschedule a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Not Availability1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cal Availability ": {
      "main": [
        [
          {
            "node": "found slot?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-11-15T17:28:39.109Z",
  "id": "5LfFRdaepFJdM4yE",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "COMP Cal.com",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "de856eaf-9065-41e0-ace1-6f9501b1a6d4",
              "name": "cal_api",
              "value": "https://api.cal.com",
              "type": "string"
            },
            {
              "id": "49f1f9ae-601d-40cc-b129-fa950b822ede",
              "name": "username",
              "value": "williamalmeida",
              "type": "string"
            },
            {
              "id": "99df0bed-0ef3-4a38-ae55-0db00096415c",
              "name": "cal_event_id",
              "value": "",
              "type": "string"
            },
            {
              "id": "0a72c23b-7e8c-4618-b827-602200390069",
              "name": "cal_api_version_booking",
              "value": "2024-08-13",
              "type": "string"
            },
            {
              "id": "7e6a29c2-9869-409d-9980-698909fdee57",
              "name": "cal_api_version_event",
              "value": "2024-06-14",
              "type": "string"
            },
            {
              "id": "9e124983-4ae7-4c0c-88b1-d1a68136a45f",
              "name": "utc",
              "value": "3",
              "type": "string"
            },
            {
              "id": "20964151-a5f0-40b4-8730-937b9ffd8a75",
              "name": "action",
              "value": "={{ $json.action }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        960,
        -580
      ],
      "id": "0f89d8cc-a0ef-42eb-ae6a-f0762f272bab",
      "name": "baseInfo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.status == 'success' && $json.data.hasField('slots') }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1640,
        -1080
      ],
      "id": "2b3c1d3d-d32d-4738-beff-3c3c31338bc5",
      "name": "found slots?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/bookings/{{ $json.data.uid }}/reschedule",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=cal-api-version",
              "value": "={{ $('baseInfo').item.json.cal_api_version_booking }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "start",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().toUTC() }}"
            },
            {
              "name": "reschedulingReason",
              "value": "={{ $('EWT').item.json.query.reschedulingReason ?? '' }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2960,
        -540
      ],
      "id": "4433fcec-adcc-479b-80a0-d4524ceb807d",
      "name": "Reschedule a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/bookings/{{ $('EWT').item.json.query.booking_uid }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=cal-api-version",
              "value": "={{ $json.cal_api_version_booking }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1460,
        -520
      ],
      "id": "8c02ea1e-f4b4-4595-91dd-894382b69b49",
      "name": "Get a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        780,
        -580
      ],
      "id": "e1ae25bf-04b6-49be-abc5-6ccd00dcd537",
      "name": "EWT"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/bookings/{{ $json.data.uid }}/cancel",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=cal-api-version",
              "value": "={{ $('baseInfo').item.json.cal_api_version_booking }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "cancellationReason",
              "value": "={{ $('EWT').item.json.query.cancellationReason }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2780,
        -740
      ],
      "id": "3fefea08-1e82-4704-ad0c-47d3875f4af3",
      "name": "Cancel a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "availability",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "availability"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "140c8bbd-d80b-49be-8c68-6062ddc72bf0",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "list bookings",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "list bookings"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "aee40e66-debf-4d99-b02e-4bb1b97e92eb",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "cancel booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancel booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "062dd5e0-6ee4-4821-98cb-19d42af6462b",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "find booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "find booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8bee3e99-040a-40e1-90f2-6971d2c6ad82",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "reschedule booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reschedule booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "80aff94c-0b8b-41bc-8593-5531774ff819",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "schedule booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "schedule booking"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1140,
        -600
      ],
      "id": "f11f4110-7b21-4060-8504-1e1ecc3149c6",
      "name": "Switch Action"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "aee40e66-debf-4d99-b02e-4bb1b97e92eb",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "cancel booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancel booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bb06766f-56b8-4de5-a92b-050ea094b118",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "reschedule booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reschedule booking"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2320,
        -520
      ],
      "id": "6931d269-3ccc-473a-8842-9e6b0083f7b3",
      "name": "Switch Action 2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0dddcb7b-df63-4b9a-89ad-d426cdf9e16f",
              "name": "response",
              "value": "={{ {\n    id: $json.data.id,\n    uid: $json.data.uid,\n    title: $json.data.title,\n    description: $json.data.description,\n    status: $json.data.status,\n    start: $json.data.start.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    end: $json.data.end.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    duration: $json.data.duration,\n    eventType: $json.data.eventType,\n    location: $json.data.location,\n} }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2460,
        -340
      ],
      "id": "32ec4b66-94fa-4c7b-90ef-0eb2b4aa7b85",
      "name": "Response A Booking"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4db37e4c-1025-406f-9498-363df3cbd585",
              "name": "response",
              "value": "={{ $json.data.map(item => `- ${item.title}, with the description \"${item.description || 'no description'}\". The status is ${item.status}, starting on ${item.start} and ending on ${item.end}, duration ${item.duration} min. The event type is ${item.eventType.slug.replace('-', ' ')} and will take place in ${item.location == 'integrations:daily' ? 'Cal Video' : item.location}. Booking details: ID - ${item.id}, UID - ${item.uid}`).join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2020,
        -760
      ],
      "id": "38cf5837-60a6-4e35-bce5-e4686a4810c0",
      "name": "Response All Bookings",
      "notes": "{{ $json.data.map(item => i = {\n    id: item.id,\n    uid: item.uid,\n    title: item.title,\n    description: item.description,\n    status: item.status,\n    start: item.start,\n    end: item.end,\n    duration: item.duration,\n    eventType: item.eventType,\n    location: item.location == 'integrations:daily' ? 'Cal Vídeo' : item.location,\n}) }}"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/bookings",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "calApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=cal-api-version",
              "value": "={{ $('baseInfo').item.json.cal_api_version_booking }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "start",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().toUTC() }}"
            },
            {
              "name": "eventTypeId",
              "value": "={{ $('EWT').item.json.query.event_id.toNumber() }}"
            },
            {
              "name": "bookingFieldsResponses",
              "value": "={{ {\n  notes: $('EWT').item?.json?.query?.description || '',\n  cellphone: `+${$('EWT').item?.json?.query?.bookingFieldsResponses?.cellphone?.startsWith('55') \n    ? $('EWT').item.json.query.bookingFieldsResponses.cellphone \n    : '55' + $('EWT').item?.json?.query?.bookingFieldsResponses?.cellphone || ''}`,\n  title: $('EWT').item?.json?.query?.title || '',\n  professional: $('EWT').item?.json?.query?.bookingFieldsResponses?.professional || '',\n  procedure: $('EWT').item?.json?.query?.bookingFieldsResponses?.procedure || '',\n  method_payment: $('EWT').item?.json?.query?.bookingFieldsResponses?.method_payment || '',\n  name_plan: $('EWT').item?.json?.query?.bookingFieldsResponses?.name_plan || '',\n  price: $('EWT').item?.json?.query?.bookingFieldsResponses?.price || ''\n} }}"
            },
            {
              "name": "attendee",
              "value": "={{ {\n  name: $('EWT').item.json.query.attendee.name,\n  email: $('EWT').item.json.query.attendee.email,\n  timeZone: 'America/Sao_Paulo',\n  language: 'pt-BR'\n} }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1680,
        -180
      ],
      "id": "546f87f8-1caa-43e3-95cc-35e7b8078407",
      "name": "Schedule a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "eee23fa6-0985-46ab-8477-ddca2d7b304b",
              "name": "data",
              "value": "={{ \n  $json.response.reduce((acc, item) => {\n    item.times.forEach(time => {\n      const t = time.toDateTime();\n      const date = t.format('y-M-d');\n      const hour = t.format('H:mm');\n\n      const existingDate = acc.find(group => group.date === date);\n      if (existingDate) {\n        existingDate.times.push(hour);\n      } else {\n        acc.push({ date: date, times: [hour] });\n      }\n    });\n    return acc;\n  }, [])\n}}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2020,
        -1160
      ],
      "id": "39f0b412-6404-46f8-abbe-30368b2aad5f",
      "name": "Format Slots"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ `error: ${$('EWT').item.json.query.event_id ? 'event id not sent, ' : ''}` + $json.error.details.errors.first().constraints?.toJsonString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        -1000
      ],
      "id": "0e4793bb-8203-438d-8517-f703c0e8f941",
      "name": "Response Availability Error"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ $json.data.rescheduledFromUid ? 'booking was rescheduled' : '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3140,
        -540
      ],
      "id": "dd8ba6f3-1095-457f-87d8-142ed5d278fe",
      "name": "Response Reschedule Booking"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ $json.data.status ? 'booking was cancelled' : 'error on cancel booking' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2960,
        -740
      ],
      "id": "938355d5-fb67-483c-968a-5770276ed8b6",
      "name": "Response Cancel Booking"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "bed3d75f-289b-401a-a2c1-534dcd8fae94",
              "leftValue": "={{ $json.data.status }}",
              "rightValue": "cancelled",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2580,
        -760
      ],
      "id": "5f5b8486-25ff-4b36-a54f-ef9824b4139d",
      "name": "booking cancelled?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "booking was cancelled",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2780,
        -920
      ],
      "id": "dd841459-e2ee-4232-814a-e8ca304291ef",
      "name": "Response Bokking Cancelled"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7f17ee24-d262-46f1-8149-a7dea7de96df",
              "name": "data",
              "value": "={{ \n  $json.data.map(event => {\n    const newEvent = { ...event };\n\n    newEvent.start = newEvent.start.toDateTime().toLocal().format('y-M-d H:mm');\n    newEvent.end = newEvent.end.toDateTime().toLocal().format('y-M-d H:mm');\n    newEvent.status = newEvent.status == 'accepted' ? 'scheduled' : newEvent.status;\n\n    return newEvent;\n  })\n}}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        -760
      ],
      "id": "6db0bfe3-0ca4-4387-9e12-81195115ec3d",
      "name": "Adjust DateTime 2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7f17ee24-d262-46f1-8149-a7dea7de96df",
              "name": "response",
              "value": "={{ \n  $json.data.slots.keys().map(date => {\n    return {\n      times: $json.data.slots[date].map(slot => {\n        const s = slot.time.toDateTime().toLocal();\n        return s;\n      })\n    };\n  })\n}}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        -1160
      ],
      "id": "ea92d076-4f29-42f8-b8a7-0dffc75ca461",
      "name": "Adjust DateTime 1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4db37e4c-1025-406f-9498-363df3cbd585",
              "name": "response",
              "value": "=slots found: {{ $json.data.toJsonString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2200,
        -1160
      ],
      "id": "903ea852-ad3c-458c-8f70-e31eac77ab1a",
      "name": "Response Slots",
      "notes": "{{ $json.data.map(item => i = {\n    id: item.id,\n    uid: item.uid,\n    title: item.title,\n    description: item.description,\n    status: item.status,\n    start: item.start,\n    end: item.end,\n    duration: item.duration,\n    eventType: item.eventType,\n    location: item.location == 'integrations:daily' ? 'Cal Vídeo' : item.location,\n}) }}"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/bookings",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "status",
              "value": "={{ $('EWT').item.json.query.status == 'all' || !$('EWT').item.json.query.status.length ? ['upcoming','recurring','past','unconfirmed'].join(',') : ['upcoming','recurring','past','unconfirmed','cancelled'].filter(item => item == $('EWT').item.json.query.status).join(',') }}"
            },
            {
              "name": "attendeeEmail",
              "value": "={{ $('EWT').item.json.query.attendeeEmail ?? '' }}"
            },
            {
              "name": "take",
              "value": "5"
            },
            {
              "name": "sortCreated",
              "value": "desc"
            },
            {
              "name": "afterStart",
              "value": "={{ $now.minus(2, 'days').toUTC()}}"
            },
            {
              "name": "eventTypeIds",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=cal-api-version",
              "value": "={{ $json.cal_api_version_booking }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1600,
        -680
      ],
      "id": "da4445fa-f975-4e5f-9dc6-b21039f21a09",
      "name": "Get all bookings by Event",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      },
      "notes": "status: {{ ['upcoming','recurring','past','cancelled','unconfirmed'].join(',') }}"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/bookings",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "status",
              "value": "={{ $('EWT').item.json.query.status == 'all' || !$('EWT').item.json.query.status.length ? ['upcoming','recurring','past','unconfirmed'].join(',') : ['upcoming','recurring','past','unconfirmed','cancelled'].filter(item => item == $('EWT').item.json.query.status).join(',') }}"
            },
            {
              "name": "attendeeEmail",
              "value": "={{ $('EWT').item.json.query.attendeeEmail ?? '' }}"
            },
            {
              "name": "take",
              "value": "5"
            },
            {
              "name": "sortCreated",
              "value": "desc"
            },
            {
              "name": "afterStart",
              "value": "={{ $now.minus(2, 'days').toUTC()}}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=cal-api-version",
              "value": "={{ $json.cal_api_version_booking }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1600,
        -820
      ],
      "id": "ca30ba24-7193-4804-a2ea-6107c67cbc11",
      "name": "Get all bookings",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      },
      "notes": "status: {{ ['upcoming','recurring','past','cancelled','unconfirmed'].join(',') }}"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $('EWT').item.json.query.event_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1420,
        -760
      ],
      "id": "6b2ad292-c11c-43fa-815d-053638d62696",
      "name": "all events?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.status == 'success' && $json.data.hasField('uid') }}",
              "rightValue": "error",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1860,
        -180
      ],
      "id": "5e6e3661-2c63-44e5-a2cf-5436e4552a59",
      "name": "scheduled?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0dddcb7b-df63-4b9a-89ad-d426cdf9e16f",
              "name": "response2",
              "value": "={{ $json.status == 'success' && $json.data.uid ? {\n    id: $json.data.id,\n    uid: $json.data.uid,\n    title: $json.data.title,\n    description: $json.data.description,\n    status: $json.data.status,\n    start: $json.data.start.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    end: $json.data.end.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    duration: $json.data.duration,\n    eventType: $json.data.eventType,\n    location: $json.data.location,\n    professional: $json.data.bookingFieldsResponses.professional,\n    procedure: $json.data.bookingFieldsResponses.procedure,\n    method_payment: $json.data.bookingFieldsResponses.method_payment,\n    name_plan: $json.data.bookingFieldsResponses.name_plan,\n    price: $json.data.bookingFieldsResponses.price,\n} : 'error on booking' }}",
              "type": "string"
            },
            {
              "id": "da8ee72e-8e29-49ad-b4aa-a41a61542fcd",
              "name": "response",
              "value": "={{ \n    $json.status == 'success' && $json.data.uid \n    ? `- ${$json.data.title}, with the description \"${$json.data.description || 'no description'}\". The status is ${$json.data.status}, starting on ${$json.data.start.toDateTime().toLocal().format('yyyy-MM-dd H:mm')} and ending on ${$json.data.end.toDateTime().toLocal().format('yyyy-MM-dd H:mm')}, duration ${$json.data.duration} min. The event type is ${$json.data.eventType.slug.replace('-', ' ')} and will take place in ${$json.data.location == 'integrations:daily' ? 'Cal Video' : $json.data.location}. Booking details: ID - ${$json.data.id}, UID - ${$json.data.uid}.`\n    : 'error on booking'\n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2080,
        -260
      ],
      "id": "98e7bcee-c764-4c2e-8e0a-f78d6d990099",
      "name": "Response Schedule Success"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "=errors found: {{ $json.error.details.hasField('errors') ? $json.error.details.errors\n  .map(item => item.constraints ? Object.values(item.constraints).join(';') : '')\n  .filter(constraint => constraint !== '')\n  .join('; ') : $json.error.message\n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2080,
        -80
      ],
      "id": "9e662f40-07a8-4dcd-9595-ca7dc69b5c1d",
      "name": "Response Schedule Error"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ $json.error.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        -440
      ],
      "id": "1f4f05a6-44fc-46bd-ab58-c080ea934fb9",
      "name": "Response Get Booking Error"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.status == 'success' && $json.data.hasField('uid') }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1640,
        -520
      ],
      "id": "75885bd5-b9d6-4ee1-adb0-b8a6bec88779",
      "name": "found booking?"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/slots/available",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "eventTypeId",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            },
            {
              "name": "startTime",
              "value": "={{ $('EWT').item.json.query.startTime.toDateTime().toUTC() }}"
            },
            {
              "name": "endTime",
              "value": "={{ $('EWT').item.json.query.endTime.toDateTime().plus(1, 'hours').toUTC() }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1480,
        -1080
      ],
      "id": "ef2c4657-fd2d-4a40-b0e8-6e8d3d4b2e09",
      "name": "Cal Availability",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.data.hasField('slots') && !$json.data.slots.isEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1500,
        -160
      ],
      "id": "3545c0b1-248a-4a33-97d9-5e77c988fdff",
      "name": "found slot?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "=error found: Requested appointment time is no longer available.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1680,
        0
      ],
      "id": "eefd0598-0504-47bc-a303-00d87455b785",
      "name": "Response Not Availability"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/slots/available",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "eventTypeId",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            },
            {
              "name": "startTime",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().toUTC() }}"
            },
            {
              "name": "endTime",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().plus(1, 'hours').toUTC() }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1320,
        -160
      ],
      "id": "33385f25-b3a4-4386-8dc4-c07885d7a5a9",
      "name": "Cal Availability 2",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      },
      "notes": "[\n  {\n    \"data\": {\n      \"slots\": {\n        \"2024-11-22\": [\n          {\n            \"time\": \"2024-11-22T18:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T19:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T20:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T21:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T22:00:00.000Z\"\n          }\n        ]\n      }\n    },\n    \"status\": \"success\"\n  }\n]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.data.hasField('slots') && !$json.data.slots.isEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2760,
        -520
      ],
      "id": "4337946c-8a65-410f-b6ec-5581f6113d30",
      "name": "found slot?1"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.cal_api }}/v2/slots/available",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "eventTypeId",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            },
            {
              "name": "startTime",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().plus(3, 'hours').toISO() }}"
            },
            {
              "name": "endTime",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().plus(4, 'hours').toISO() }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2580,
        -520
      ],
      "id": "17cf60a9-af60-48d8-bf41-fdf1685a2af0",
      "name": "Cal Availability ",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "Xk4lHr8zzqWTdh4Z",
          "name": "Cal.com Token"
        }
      },
      "notes": "[\n  {\n    \"data\": {\n      \"slots\": {\n        \"2024-11-22\": [\n          {\n            \"time\": \"2024-11-22T18:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T19:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T20:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T21:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T22:00:00.000Z\"\n          }\n        ]\n      }\n    },\n    \"status\": \"success\"\n  }\n]"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "=error found: Requested appointment time is no longer available.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2960,
        -380
      ],
      "id": "c3095f09-49c9-4ee1-b70d-ce2e0639fec6",
      "name": "Response Not Availability1"
    }
  ],
  "pinData": {
    "EWT": [
      {
        "json": {
          "query": {
            "event_id": "1",
            "startTime": "2024-12-17T00:00:00Z",
            "endTime": "2024-12-18T00:00:00Z"
          },
          "action": "availability"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Cal.com Trigger": {
      "webhookId": "992ce188-0fce-4a68-866f-f76b682bdcb5"
    }
  },
  "tags": [
    {
      "createdAt": "2024-09-27T17:42:17.034Z",
      "updatedAt": "2024-09-27T17:42:17.034Z",
      "id": "TsfCA8eZuTObjOfy",
      "name": "Backup"
    },
    {
      "createdAt": "2024-10-30T23:31:05.255Z",
      "updatedAt": "2024-10-30T23:31:05.255Z",
      "id": "IDsda42rHm8bi7eR",
      "name": "Tool"
    },
    {
      "createdAt": "2024-10-31T06:44:33.847Z",
      "updatedAt": "2024-10-31T06:44:33.847Z",
      "id": "6vgbvfx4GT5juXVA",
      "name": "Component"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-12-17T14:17:00.853Z",
  "versionId": "63d61c4b-625b-436f-bb2e-abd3065eae78"
}