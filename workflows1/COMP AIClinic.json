{
  "active": false,
  "connections": {
    "baseInfo": {
      "main": [
        [
          {
            "node": "Switch Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found slots?": {
      "main": [
        [
          {
            "node": "Adjust DateTime 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Availability Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a booking": {
      "main": [
        [
          {
            "node": "found booking?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EWT": {
      "main": [
        [
          {
            "node": "baseInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Action": {
      "main": [
        [
          {
            "node": "Cal Availability",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "all events?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cal Availability 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Action 2": {
      "main": [
        [
          {
            "node": "booking cancelled?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cal Availability ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response A Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule a booking": {
      "main": [
        [
          {
            "node": "scheduled?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancel a booking": {
      "main": [
        [
          {
            "node": "Response Cancel Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reschedule a booking": {
      "main": [
        [
          {
            "node": "Response Reschedule Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "booking cancelled?": {
      "main": [
        [
          {
            "node": "Response Bokking Cancelled",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancel a booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adjust DateTime 1": {
      "main": [
        [
          {
            "node": "Format Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adjust DateTime 2": {
      "main": [
        [
          {
            "node": "Response All Bookings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Slots": {
      "main": [
        [
          {
            "node": "Response Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get all bookings by Event": {
      "main": [
        [
          {
            "node": "Adjust DateTime 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get all bookings": {
      "main": [
        [
          {
            "node": "Adjust DateTime 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "all events?": {
      "main": [
        [
          {
            "node": "Get all bookings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get all bookings by Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "scheduled?": {
      "main": [
        [
          {
            "node": "Response Schedule Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Schedule Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found booking?": {
      "main": [
        [
          {
            "node": "Switch Action 2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Get Booking Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cal Availability": {
      "main": [
        [
          {
            "node": "found slots?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found slot?": {
      "main": [
        [
          {
            "node": "Schedule a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Not Availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cal Availability 2": {
      "main": [
        [
          {
            "node": "found slot?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "found slot?1": {
      "main": [
        [
          {
            "node": "Reschedule a booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Not Availability1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cal Availability ": {
      "main": [
        [
          {
            "node": "found slot?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-12-17T14:17:28.065Z",
  "id": "QTrKQkY4jxrACTpy",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "COMP AIClinic",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "de856eaf-9065-41e0-ace1-6f9501b1a6d4",
              "name": "url_api",
              "value": "https://agendaclinic.com/api/v1",
              "type": "string"
            },
            {
              "id": "20964151-a5f0-40b4-8730-937b9ffd8a75",
              "name": "action",
              "value": "={{ $json.action }}",
              "type": "string"
            },
            {
              "id": "270b86fe-380c-407e-93aa-f5fc5cd3027f",
              "name": "utc",
              "value": "3",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        860,
        20
      ],
      "id": "590bc879-f29c-41a5-b1b3-d1369862aa29",
      "name": "baseInfo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.status == 'success' && $json.data.hasField('slots') && $json.data.slots.isNotEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1540,
        -480
      ],
      "id": "707bb46e-7f89-44de-98b2-578b25ad856a",
      "name": "found slots?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('baseInfo').item.json.url_api }}/appointments/{{ $json.data.uid }}/reschedule",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "start_time",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().toUTC() }}"
            },
            {
              "name": "rescheduling_reason",
              "value": "={{ $('EWT').item.json.query.rescheduling_reason ?? '' }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2860,
        60
      ],
      "id": "14b2115c-3ba3-4d30-b7e7-8f889134ad95",
      "name": "Reschedule a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.url_api }}/appointments/{{ $('EWT').item.json.query.booking_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        80
      ],
      "id": "ca4f86ed-4797-4747-91b3-7dda4022866f",
      "name": "Get a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        680,
        20
      ],
      "id": "108143d7-c8bf-49b2-98e7-e368e136bd11",
      "name": "EWT"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('baseInfo').item.json.url_api }}/appointments/{{ $json.data.id }}/cancel",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "cancellation_reason",
              "value": "={{ $('EWT').item.json.query.cancellation_reason }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2680,
        -140
      ],
      "id": "0473de2d-4984-4d3e-bc02-b92c47f53275",
      "name": "Cancel a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "availability",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "availability"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "140c8bbd-d80b-49be-8c68-6062ddc72bf0",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "list bookings",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "list bookings"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "aee40e66-debf-4d99-b02e-4bb1b97e92eb",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "cancel booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancel booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "062dd5e0-6ee4-4821-98cb-19d42af6462b",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "find booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "find booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8bee3e99-040a-40e1-90f2-6971d2c6ad82",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "reschedule booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reschedule booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "80aff94c-0b8b-41bc-8593-5531774ff819",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "schedule booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "schedule booking"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1040,
        0
      ],
      "id": "1dc01010-e23b-4e2e-9d12-cf5ef0f828a5",
      "name": "Switch Action"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "aee40e66-debf-4d99-b02e-4bb1b97e92eb",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "cancel booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancel booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bb06766f-56b8-4de5-a92b-050ea094b118",
                    "leftValue": "={{ $('baseInfo').item.json.action }}",
                    "rightValue": "reschedule booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reschedule booking"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2220,
        80
      ],
      "id": "97edba07-cfd0-4c88-b692-bcd819695af3",
      "name": "Switch Action 2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0dddcb7b-df63-4b9a-89ad-d426cdf9e16f",
              "name": "response",
              "value": "={{ {\n    id: $json.data.id,\n    title: $json.data.title,\n    description: $json.data.description,\n    status: $json.data.status,\n    start: $json.data.start_time.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    end: $json.data.end_time.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    duration: $json.data.duration,\n    event_id: $json.data.event_id\n} }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2360,
        260
      ],
      "id": "cabb7624-9efd-457a-95f1-b112bb056302",
      "name": "Response A Booking"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4db37e4c-1025-406f-9498-363df3cbd585",
              "name": "response",
              "value": "={{ $json.data.map(item => `- ${item.title}, with the description \"${item.description || 'no description'}\". The status is ${item.status}, starting on ${item.start_time} and ending on ${item.end_time}, duration ${item.duration} min. Booking details: ID - ${item.id}`).join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1920,
        -160
      ],
      "id": "80773eb3-beb3-43cd-a0a1-15dfe423747a",
      "name": "Response All Bookings",
      "notes": "{{ $json.data.map(item => i = {\n    id: item.id,\n    uid: item.uid,\n    title: item.title,\n    description: item.description,\n    status: item.status,\n    start: item.start,\n    end: item.end,\n    duration: item.duration,\n    eventType: item.eventType,\n    location: item.location == 'integrations:daily' ? 'Cal Vídeo' : item.location,\n}) }}"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('baseInfo').item.json.url_api }}/appointments",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "start_time",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().toUTC() }}"
            },
            {
              "name": "event_id",
              "value": "={{ $('EWT').item.json.query.event_id.toNumber() }}"
            },
            {
              "name": "bookingFieldsResponses",
              "value": "={{ {\n  notes: $('EWT').item?.json?.query?.description || '',\n  cellphone: `+${$('EWT').item?.json?.query?.bookingFieldsResponses?.cellphone?.startsWith('55') \n    ? $('EWT').item.json.query.bookingFieldsResponses.cellphone \n    : '55' + $('EWT').item?.json?.query?.bookingFieldsResponses?.cellphone || ''}`,\n  title: $('EWT').item?.json?.query?.title || '',\n  professional: $('EWT').item?.json?.query?.bookingFieldsResponses?.professional || '',\n  procedure: $('EWT').item?.json?.query?.bookingFieldsResponses?.procedure || '',\n  method_payment: $('EWT').item?.json?.query?.bookingFieldsResponses?.method_payment || '',\n  name_plan: $('EWT').item?.json?.query?.bookingFieldsResponses?.name_plan || '',\n  price: $('EWT').item?.json?.query?.bookingFieldsResponses?.price || ''\n} }}"
            },
            {
              "name": "attendee",
              "value": "={{ {\n  name: $('EWT').item.json.query.attendee.name,\n  email: $('EWT').item.json.query.attendee.email,\n  timeZone: 'America/Sao_Paulo',\n  language: 'pt-BR'\n} }}"
            },
            {
              "name": "pacient_id",
              "value": "={{ $('EWT').item.json.query.pacient_id }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1580,
        420
      ],
      "id": "351b51d5-45da-4ae5-b215-62b23b99244a",
      "name": "Schedule a booking",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "eee23fa6-0985-46ab-8477-ddca2d7b304b",
              "name": "data",
              "value": "={{ \n  $json.response.reduce((acc, item) => {\n    item.times.forEach(time => {\n      const t = time.toDateTime();\n      const date = t.format('y-M-d');\n      const hour = t.format('H:mm');\n\n      const existingDate = acc.find(group => group.date === date);\n      if (existingDate) {\n        existingDate.times.push(hour);\n      } else {\n        acc.push({ date: date, times: [hour] });\n      }\n    });\n    return acc;\n  }, [])\n}}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1920,
        -560
      ],
      "id": "1c2359a0-3850-4f5c-9c0e-9949cc094f50",
      "name": "Format Slots"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ $json.status == 'error' ? $json.message : 'slots not found' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1740,
        -400
      ],
      "id": "0fb06935-0f41-4384-b937-4c6d60820caa",
      "name": "Response Availability Error"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ $json.data.rescheduledFromUid ? 'booking was rescheduled' : '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3040,
        60
      ],
      "id": "91e7c127-c48f-45b2-947e-17e708f1e919",
      "name": "Response Reschedule Booking"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ $json.data.status ? 'booking was cancelled' : 'error on cancel booking' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2860,
        -140
      ],
      "id": "3f4c7902-6ad9-4c55-9043-d4b809967e5a",
      "name": "Response Cancel Booking"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "bed3d75f-289b-401a-a2c1-534dcd8fae94",
              "leftValue": "={{ $json.data.status }}",
              "rightValue": "cancelled",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2480,
        -160
      ],
      "id": "ea49d11c-6c96-4165-a11e-ec0882f60527",
      "name": "booking cancelled?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "booking was cancelled",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2680,
        -320
      ],
      "id": "7b0486de-a879-4172-b90d-ff5317d99914",
      "name": "Response Bokking Cancelled"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7f17ee24-d262-46f1-8149-a7dea7de96df",
              "name": "data",
              "value": "={{ \n  $json.data.map(event => {\n    const newEvent = { ...event };\n\n    newEvent.start_time = newEvent.start_time.toDateTime().toLocal().format('y-M-d H:mm');\n    newEvent.end_time = newEvent.end_time.toDateTime().toLocal().format('y-M-d H:mm');\n    newEvent.status = newEvent.status == 'confirmed' ? 'scheduled' : newEvent.status;\n\n    return newEvent;\n  })\n}}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1740,
        -160
      ],
      "id": "117ce3a3-67bf-4263-84dc-aad535b43d1d",
      "name": "Adjust DateTime 2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7f17ee24-d262-46f1-8149-a7dea7de96df",
              "name": "response",
              "value": "={{ \n  $json.data.slots.keys().map(date => {\n    return {\n      times: $json.data.slots[date].map(slot => {\n        const s = slot.time.toDateTime().toLocal();\n        return s;\n      })\n    };\n  })\n}}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1740,
        -560
      ],
      "id": "bbfa233b-0076-42e9-b0a7-ce89d685b791",
      "name": "Adjust DateTime 1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4db37e4c-1025-406f-9498-363df3cbd585",
              "name": "response",
              "value": "=slots found: {{ $json.data.toJsonString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2100,
        -560
      ],
      "id": "10676d8a-44e3-4db7-afe9-586388a54ba6",
      "name": "Response Slots",
      "notes": "{{ $json.data.map(item => i = {\n    id: item.id,\n    uid: item.uid,\n    title: item.title,\n    description: item.description,\n    status: item.status,\n    start: item.start,\n    end: item.end,\n    duration: item.duration,\n    eventType: item.eventType,\n    location: item.location == 'integrations:daily' ? 'Cal Vídeo' : item.location,\n}) }}"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.url_api }}/appointments",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "status",
              "value": "={{ $('EWT').item.json.query.status == 'all' || !$('EWT').item.json.query.status.length ? ['pending','confirmed','completed'].join(',') : ['pending','confirmed','completed','cancelled'].filter(item => item == $('EWT').item.json.query.status).join(',') }}"
            },
            {
              "name": "pacient_email",
              "value": "={{ $('EWT').item.json.query.attendeeEmail ?? '' }}"
            },
            {
              "name": "take",
              "value": "5"
            },
            {
              "name": "sortCreated",
              "value": "desc"
            },
            {
              "name": "start_time",
              "value": "={{ $now.minus(2, 'days').toUTC()}}"
            },
            {
              "name": "event_id",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1500,
        -80
      ],
      "id": "7c37f983-2895-4517-8176-a8c19f95348e",
      "name": "Get all bookings by Event",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      },
      "notes": "status: {{ ['upcoming','recurring','past','cancelled','unconfirmed'].join(',') }}"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.url_api }}/appointments",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "status",
              "value": "={{ $('EWT').item.json.query.status == 'all' || !$('EWT').item.json.query.status.length ? ['pending','confirmed','completed'].join(',') : ['pending','confirmed','completed','cancelled'].filter(item => item == $('EWT').item.json.query.status).join(',') }}"
            },
            {
              "name": "pacient_email",
              "value": "={{ $('EWT').item.json.query.attendeeEmail ?? '' }}"
            },
            {
              "name": "take",
              "value": "5"
            },
            {
              "name": "sortCreated",
              "value": "desc"
            },
            {
              "name": "start_time",
              "value": "={{ $now.minus(2, 'days').toUTC()}}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1500,
        -220
      ],
      "id": "da62f37a-7219-445d-b1e1-2b427967e536",
      "name": "Get all bookings",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      },
      "notes": "status: {{ ['upcoming','recurring','past','cancelled','unconfirmed'].join(',') }}"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $('EWT').item.json.query.event_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1320,
        -160
      ],
      "id": "bd149818-1bdc-4e8c-bcdd-08f6283f5ea4",
      "name": "all events?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.status == 'success' && $json.data.hasField('id') }}",
              "rightValue": "error",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1760,
        420
      ],
      "id": "eb0851e6-c452-4380-8db9-252250c09b5c",
      "name": "scheduled?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0dddcb7b-df63-4b9a-89ad-d426cdf9e16f",
              "name": "response2",
              "value": "={{ $json.status == 'success' && $json.data.id ? {\n    id: $json.data.id,\n    title: $json.data.title,\n    description: $json.data.description,\n    status: $json.data.status,\n    start: $json.data.start_time.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    end: $json.data.end_time.toDateTime().toLocal().format('yyyy-MM-dd H:mm'),\n    duration: $json.data.duration,\n    event_id: $json.data.event_id,\n} : 'error on booking' }}",
              "type": "string"
            },
            {
              "id": "da8ee72e-8e29-49ad-b4aa-a41a61542fcd",
              "name": "response",
              "value": "={{ \n    $json.status == 'success' && $json.data.id \n    ? `- ${$json.data.title}, with the description \"${$json.data.description || 'no description'}\". The status is ${$json.data.status}, starting on ${$json.data.start_time.toDateTime().toLocal().format('yyyy-MM-dd H:mm')} and ending on ${$json.data.end_time.toDateTime().toLocal().format('yyyy-MM-dd H:mm')}, duration ${$json.data.duration} min. Booking details: ID - ${$json.data.id}.`\n    : 'error on booking'\n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1980,
        340
      ],
      "id": "0533e65d-25aa-496a-a60f-71aba4d20247",
      "name": "Response Schedule Success"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "=errors found: {{ $json.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1980,
        520
      ],
      "id": "34229de4-1b8f-42a0-8a5b-cc01a06d5066",
      "name": "Response Schedule Error"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "={{ $json.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1740,
        160
      ],
      "id": "54ffd822-85f5-4fe3-a471-599b63605139",
      "name": "Response Get Booking Error"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.status == 'success' && $json.data.hasField('id') }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1540,
        80
      ],
      "id": "ab95eeb1-4682-422a-8b90-9bcb44a6a1e0",
      "name": "found booking?"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.url_api }}/slots/available",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "event_id",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            },
            {
              "name": "start_time",
              "value": "={{ $('EWT').item.json.query.startTime.toDateTime().toUTC() }}"
            },
            {
              "name": "end_time",
              "value": "={{ $('EWT').item.json.query.endTime.toDateTime().plus(1, 'hours').toUTC() }}"
            },
            {
              "name": "response_format",
              "value": "time"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1380,
        -480
      ],
      "id": "5c1a5ccd-1080-4ca1-83cc-335a0cb0fbe5",
      "name": "Cal Availability",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.status == 'success' && $json.data.hasField('slots') && $json.data.slots.isNotEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1400,
        440
      ],
      "id": "1e2aade3-f5bf-4876-8cbd-e7e24b1244d9",
      "name": "found slot?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "=error found: Requested appointment time is no longer available.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1580,
        600
      ],
      "id": "0b28eafe-a45e-4b94-bea4-ec826bca597a",
      "name": "Response Not Availability"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.url_api }}/slots/available",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "event_id",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            },
            {
              "name": "start_time",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().toUTC() }}"
            },
            {
              "name": "end_time",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().plus(1, 'hours').toUTC() }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1220,
        440
      ],
      "id": "5f949d63-c957-4f54-b10b-97819a01f2d6",
      "name": "Cal Availability 2",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      },
      "notes": "[\n  {\n    \"data\": {\n      \"slots\": {\n        \"2024-11-22\": [\n          {\n            \"time\": \"2024-11-22T18:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T19:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T20:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T21:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T22:00:00.000Z\"\n          }\n        ]\n      }\n    },\n    \"status\": \"success\"\n  }\n]"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aedcecc4-ef35-477a-b5c1-2e601eb718b9",
              "leftValue": "={{ $json.data.hasField('slots') && !$json.data.slots.isEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2660,
        80
      ],
      "id": "da0fe6d0-7fa7-4178-b146-4850494e0900",
      "name": "found slot?1"
    },
    {
      "parameters": {
        "url": "={{ $('baseInfo').item.json.url_api }}/slots/available",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "event_id",
              "value": "={{ $('EWT').item.json.query.event_id }}"
            },
            {
              "name": "start_time",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().plus(3, 'hours').toISO() }}"
            },
            {
              "name": "end_time",
              "value": "={{ $('EWT').item.json.query.start.toDateTime().plus(4, 'hours').toISO() }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2480,
        80
      ],
      "id": "718d84e6-07b2-4487-a0eb-97b11b418a13",
      "name": "Cal Availability ",
      "credentials": {
        "calApi": {
          "id": "xICGic9UQ3lxjrpb",
          "name": "william"
        },
        "httpHeaderAuth": {
          "id": "nmUmytqX7rLnklTQ",
          "name": "AI Clinic Token"
        }
      },
      "notes": "[\n  {\n    \"data\": {\n      \"slots\": {\n        \"2024-11-22\": [\n          {\n            \"time\": \"2024-11-22T18:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T19:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T20:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T21:00:00.000Z\"\n          },\n          {\n            \"time\": \"2024-11-22T22:00:00.000Z\"\n          }\n        ]\n      }\n    },\n    \"status\": \"success\"\n  }\n]"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb30d710-9962-46c5-b3cb-f0993cfd6785",
              "name": "response",
              "value": "=error found: Requested appointment time is no longer available.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2860,
        220
      ],
      "id": "dbb57cb4-4294-4a69-91a8-eb4d632835f1",
      "name": "Response Not Availability1"
    }
  ],
  "pinData": {
    "EWT": [
      {
        "json": {
          "query": {
            "start": "2024-12-18T15:00:00",
            "attendee": {
              "name": "William",
              "email": "williamkillerca@hotmail.com",
              "cellphone": "12982184879"
            },
            "event_id": "6",
            "bookingFieldsResponses": {
              "title": "Hemograma Completo"
            },
            "pacient_id": 3
          },
          "action": "schedule booking"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Cal.com Trigger": {
      "webhookId": "992ce188-0fce-4a68-866f-f76b682bdcb5"
    }
  },
  "tags": [
    {
      "createdAt": "2024-09-27T17:42:17.034Z",
      "updatedAt": "2024-09-27T17:42:17.034Z",
      "id": "TsfCA8eZuTObjOfy",
      "name": "Backup"
    },
    {
      "createdAt": "2024-10-30T23:31:05.255Z",
      "updatedAt": "2024-10-30T23:31:05.255Z",
      "id": "IDsda42rHm8bi7eR",
      "name": "Tool"
    },
    {
      "createdAt": "2024-10-31T06:44:33.847Z",
      "updatedAt": "2024-10-31T06:44:33.847Z",
      "id": "6vgbvfx4GT5juXVA",
      "name": "Component"
    },
    {
      "createdAt": "2024-12-18T13:55:11.434Z",
      "updatedAt": "2024-12-18T13:55:11.434Z",
      "id": "02kkCHve480aFjG4",
      "name": "Clinic"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-01-08T22:45:34.733Z",
  "versionId": "7918bf50-12d4-452c-9219-24acdb078c31"
}